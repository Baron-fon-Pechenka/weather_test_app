<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Погодное приложение с автодополнением</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"  rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .weather-card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            overflow: hidden;
        }
        .current-weather {
            background: linear-gradient(135deg, #6ecbf5 0%, #e2f0fd 100%);
        }
        .forecast-card {
            background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%);
        }
        .suggestions-container {
            position: relative;
        }
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .suggestion-item {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .popular-title {
            font-size: 0.9rem;
            color: #6c757d;
            padding: 8px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #0d6efd;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h1 class="text-center mb-4">Погодное приложение</h1>
                        <div class="suggestions-container mb-3">
                            <div class="input-group">
                                <input type="text"
                                       class="form-control form-control-lg"
                                       id="city-input"
                                       placeholder="Введите название города"
                                       autocomplete="off">
                                <button class="btn btn-primary btn-lg"
                                        id="get-weather-btn"
                                        type="button">
                                    <i class="bi bi-cloud-sun"></i> Погода
                                </button>
                            </div>
                            <div class="suggestions-list card" id="suggestions-list">
                                <!-- Подсказки будут появляться здесь -->
                            </div>
                        </div>

                        <!-- Сообщение о предыдущем городе -->
                        {% if last_visited %}
                        <div class="alert alert-info mt-3 text-center">
                            Хотите снова узнать погоду в {{ last_visited }}?
                            <a href="/weather?city={{ last_visited }}" class="btn btn-primary btn-sm">Показать</a>
                        </div>
                        {% endif %}

                        <div id="error-container" class="alert alert-danger d-none"></div>
                        <div id="weather-container">
                            <div class="text-center text-muted py-4">
                                <p class="lead">Введите название города, чтобы узнать погоду</p>
                                <p>Начните вводить название, и вы увидите подсказки</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const cityInput = document.getElementById('city-input');
        const suggestionsList = document.getElementById('suggestions-list');
        const getWeatherBtn = document.getElementById('get-weather-btn');

        let inputTimer;

        // Обработка фокуса на поле ввода
        cityInput.addEventListener('focus', () => {
            if (cityInput.value === '') {
                loadSuggestions('');
            }
        });

        // Обработка ввода текста
        cityInput.addEventListener('input', () => {
            clearTimeout(inputTimer);
            const query = cityInput.value.trim();

            if (query === '') {
                loadSuggestions('');
                return;
            }

            inputTimer = setTimeout(() => {
                loadSuggestions(query);
            }, 300);
        });

        // Клик вне списка — скрыть подсказки
        document.addEventListener('click', (e) => {
            if (!suggestionsList.contains(e.target) && e.target !== cityInput) {
                suggestionsList.style.display = 'none';
            }
        });

        // Клик по кнопке "Погода"
        getWeatherBtn.addEventListener('click', () => {
            const query = cityInput.value.trim();
            if (query) {
                window.location.href = '/weather?city=' + encodeURIComponent(query);
            }
        });

        // Функция загрузки подсказок
        function loadSuggestions(query) {
            fetch(`/autocomplete?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(cities => {
                    renderSuggestions(cities, query);
                })
                .catch(() => {
                    suggestionsList.style.display = 'none';
                });
        }

        // Отображение подсказок
        function renderSuggestions(cities, query) {
            if (cities.length === 0) {
                suggestionsList.style.display = 'none';
                return;
            }

            let html = '';
            if (query === '') {
                html += `<div class="popular-title">Популярные города:</div>`;
            }

            cities.forEach(city => {
                html += `
                    <div class="suggestion-item" data-city='${JSON.stringify(city)}'>
                        <i class="bi bi-geo-alt"></i> ${city.name}
                    </div>
                `;
            });

            suggestionsList.innerHTML = html;
            suggestionsList.style.display = 'block';

            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const city = JSON.parse(item.dataset.city);
                    cityInput.value = city.name;
                    suggestionsList.style.display = 'none';
                    window.location.href = '/weather?city=' + encodeURIComponent(city.name);
                });
            });
        }
    </script>
</body>
</html>